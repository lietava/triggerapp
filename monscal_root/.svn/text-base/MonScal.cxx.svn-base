#include "MonScal.h"
#include "ctpcounters.h"
#include "ActiveRun.h"
#include <iostream>
#include <sstream>
#include <unistd.h>
#define RUNXCOUNTERSSTART (CSTART_BUSY+NCOUNTERS_BUSY_RUNX1)
char machine;
MonScal::MonScal(w32 kPrint,bool copycount2OCDB)
:
buffer(0),
inputs(0),
kPrint(kPrint),
count(0),
updateflag(0),
copycount2OCDB(copycount2OCDB)
{
 char name[32];
 gethostname(name,32);
 machine = name[11];
 cout << "Machine: " << name << " "<< machine <<  endl; 
 for(int i=0;i<NRUN;i++)activeruns[i]=0;
 if(SCAL()){
  inputs = new ActiveRun(0);
  inputs->CreateDisplaySCAL();
 }
 cout << "Monscal created. Output option= " << kPrint << endl;
}
MonScal::~MonScal()
{
 // close all static files
 DisplaySCAL::GetfileSCAL()->close();
 PrintLog("Exiting MonScal.");
}
void MonScal::GetActiveRuns()
{
 this->buffer=buffer;
 updateflag=0;
 for(int i=0;i<NRUN;i++){
    int run=buffer[RUNXCOUNTERSSTART+i];
    //cout << i << " " << run << " " << buffer[CSTART_SPEC] << endl;
    if(run && activeruns[i]==0){
      // new run
      StartActiveRun(i,run);
      UpdateActiveRun(i,run);
      updateflag=1;
    }else if(run==0 && activeruns[i]){
      // stop run
      UpdateActiveRun(i,run);
      StopActiveRun(i);
    }else if(run && activeruns[i]){
      // running run
      UpdateActiveRun(i,run);
    }
 }
 inputs->SetCheckVCTPINPUTS(updateflag);
 UpdateActiveRun(0,0);
}
void MonScal::StartActiveRun(int index,int runnum)
{
 activeruns[index] = new ActiveRun(runnum);
 ActiveRun* ar = activeruns[index];
 ar->UpdateRunCounters(buffer);
 if(runnum && SCAL())ar->CreateDisplaySCAL();
}
int MonScal::StopActiveRun(int index)
{
 ActiveRun* ar = activeruns[index];
 int runnum = ar->GetRunNumber();
 ar->UpdateRunCounters(buffer);
 if(runnum && SCAL())ar->DisplayRun(); 
 delete activeruns[index];
 activeruns[index]=0;
 return 0;
}
int MonScal::UpdateActiveRun(int index,int runnum)
{
 if(runnum==0){
    if(SCAL()){
      inputs->UpdateRunCounters(buffer);
      inputs->DisplayRun();
    }
    return 0;
 }
 ActiveRun* ar = activeruns[index];
 ar->UpdateRunCounters(buffer);
 if(runnum && SCAL())ar->DisplayRun(); 
 return 0;
}

